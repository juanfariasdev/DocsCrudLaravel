stages:
  - build
  - deploy

image: php:8.2

before_script:
  - apt-get update -qq && apt-get install -y -qq sshpass rsync curl unzip
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

build:
  stage: build
  script:
    - echo "Building the application..."
    - composer install --no-dev --prefer-dist --optimize-autoloader
    - npm install && npm run prod
    - php artisan config:cache
    - php artisan route:cache
    - php artisan view:cache
  artifacts:
    paths:
      - .env
      - vendor/
      - public/
      - resources/views/
      - routes/
      - bootstrap/
      - storage/
      - app/

deploy:
  stage: deploy
  script:
    - sshpass -p "$SSH_PASSWORD" ssh -o StrictHostKeyChecking=no -p $SSH_PORT $SSH_USER@$SSH_HOST "mkdir -p /path/to/your/project"
    - sshpass -p "$SSH_PASSWORD" rsync -avz --delete --exclude='.git/' --exclude='storage/logs/' --exclude='.env' -e "ssh -p $SSH_PORT" ./ $SSH_USER@$SSH_HOST:/path/to/your/project/
  only:
    - main
